#### 3.4. 終端機ID轉換

第三種轉換為頻率編碼或風險編碼（Frequency encoding or risk encoding）：
此種轉換涉及終端機ID，主要是建立能表徵終端機相關「風險」的新特徵。這裡的風險將定義為在三個不同時間窗口內，在該終端機上觀察到的平均詐欺次數。這將產生三個新的特徵。

最後，讓我們進行終端機ID的轉換。主要目標是提取一個風險分數，用以評估特定終端機ID暴露於詐欺交易的程度。風險分數將定義為在特定時間窗口內，某終端機ID上發生的詐欺交易平均次數。如同客戶ID轉換，我們將使用1天、7天和30天三種時間窗口。

與客戶ID轉換不同的是，這些時間窗口不會直接銜接在特定交易之前，而是會透過延遲期間進行位移。設置延遲期間的原因在於，在實務上，詐欺交易往往需要經過詐欺調查或客戶投訴後才能被發現。因此，計算風險分數所需的詐欺標記，必須等到此延遲期間後才能取得。初步估計，這個延遲期間將設定為一週。關於延遲期間的設置理由，將在第5章的驗證策略中進一步說明。

讓我們透過定義`get_count_risk_rolling_window`函式來計算風險分數。此函式接受特定終端機ID的交易資料框、延遲期間，以及時間窗口大小清單作為輸入參數。在第一階段，計算延遲期間內的交易總數和詐欺交易數（`NB_TX_DELAY`和`NB_FRAUD_DELAY`）。在第二階段，計算每個時間窗口加上延遲期間的交易總數和詐欺交易數（`NB_TX_DELAY_WINDOW`和`NB_FRAUD_DELAY_WINDOW`）。特定時間窗口內的交易總數和詐欺交易數（已依延遲期間位移），可透過計算延遲期間與時間窗口加延遲期間所得數值的差異來獲得。

`NB_FRAUD_WINDOW=NB_FRAUD_DELAY_WINDOW-NB_FRAUD_DELAY
NB_TX_WINDOW=NB_TX_DELAY_WINDOW-NB_TX_DELAY`

最後，風險分數是透過計算每個時間窗口內的詐欺交易比例而得（如果在給定窗口內沒有發生任何交易，則為0）：

`RISK_WINDOW=NB_FRAUD_WINDOW/NB_TX_WINDOW`

除了風險分數外，此函式還會回傳每個時間窗口的交易次數。這將產生六個新特徵：三個時間窗口各自對應的風險分數和交易次數。

讓我們為第一個包含詐欺交易的終端機ID計算這六個特徵：

我們可以確認第一筆詐欺交易發生在2024/09/10，且風險分數的計算是在一週的延遲期後才開始。

最後，讓我們為所有終端機產生這些特徵。使用Pandas的`groupby`和`apply`方法可以輕鬆完成這項工作。
